# ğŸš€ MVPç²¾ç®€ç‰ˆDockerfile - é’ˆå¯¹Railway 4GBé™åˆ¶ä¼˜åŒ–
# é¢„è®¡é•œåƒå¤§å°: 1.5-2GB (ä»8.5GBå¤§å¹…ç¼©å‡)

# ========== é˜¶æ®µ1: æ„å»ºä¾èµ– ==========
FROM python:3.11-slim AS builder

WORKDIR /build

# å®‰è£…ç¼–è¯‘å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# ä½¿ç”¨MVPç²¾ç®€ç‰ˆä¾èµ–
COPY requirements.mvp.txt .
RUN pip install --no-cache-dir --prefix=/install -r requirements.mvp.txt

# ========== é˜¶æ®µ2: è¿è¡Œæ—¶é•œåƒ ==========
FROM python:3.11-slim

WORKDIR /app

# åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„ç³»ç»ŸåŒ…
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶Pythonä¾èµ–
COPY --from=builder /install /usr/local

# è®¾ç½®ç¯å¢ƒå˜é‡ - å‡å°‘ç¼“å­˜å’Œæ—¥å¿—
ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    OPENAI_LOG_DIR=/tmp/openai_logs

# å¤åˆ¶åº”ç”¨ä»£ç ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
# ç¡®ä¿åˆ›å»ºäº†.dockerignore
COPY . .

# æ¸…ç†æ‰€æœ‰ä¸å¿…è¦çš„æ–‡ä»¶
RUN rm -rf /tmp/* /var/tmp/* \
    /root/.cache /root/.pip \
    /app/tests /app/docs \
    /app/*.md /app/*.MD \
    /app/.git /app/.gitignore \
    /app/__pycache__ /app/**/__pycache__ \
    /app/*.pyc /app/**/*.pyc \
    /app/.venv /app/venv \
    /app/celerybeat-schedule* \
    2>/dev/null || true

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
RUN mkdir -p $OPENAI_LOG_DIR || true

EXPOSE 8000

# ä½¿ç”¨è¾ƒå°‘çš„workerså‡å°‘å†…å­˜å ç”¨
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "2"]
