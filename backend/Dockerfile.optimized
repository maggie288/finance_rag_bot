# ğŸš€ ä¼˜åŒ–ç‰ˆDockerfile - å‡å°‘é•œåƒå¤§å°
# å¯¹æ¯”åŸç‰ˆï¼šé¢„è®¡ä»8.5GBå‡å°‘åˆ°3-4GB

# ========== é˜¶æ®µ1: æ„å»ºä¾èµ– ==========
FROM python:3.11-slim AS builder

WORKDIR /build

# å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆä»…æ„å»ºé˜¶æ®µï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…
COPY requirements.txt .
RUN pip install --no-cache-dir --prefix=/install \
    -r requirements.txt

# ========== é˜¶æ®µ2: è¿è¡Œæ—¶é•œåƒ ==========
FROM python:3.11-slim

WORKDIR /app

# âš¡ ä¼˜åŒ–1: åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„ç³»ç»ŸåŒ…
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# âš¡ ä¼˜åŒ–2: æ¸…ç†pipç¼“å­˜
COPY --from=builder /install /usr/local
RUN pip cache purge || true

# âš¡ ä¼˜åŒ–3: è®¾ç½®ç¯å¢ƒå˜é‡å‡å°‘æ—¥å¿—å’Œç¼“å­˜
ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# âš¡ ä¼˜åŒ–4: å¤åˆ¶åº”ç”¨ä»£ç ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
# .dockerignore ä¼šæ’é™¤: tests/, docs/, *.md, .git/, etc.
COPY . .

# âš¡ ä¼˜åŒ–5: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
RUN rm -rf /tmp/* \
    /var/tmp/* \
    /root/.cache \
    /root/.pip/cache || true

EXPOSE 8000

# âš¡ ä¼˜åŒ–6: ä½¿ç”¨æ›´å°‘çš„workeræ•°é‡ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "2"]
